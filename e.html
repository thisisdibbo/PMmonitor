<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Air Quality Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.22.0/firebase-database-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f0f0;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: #333;
  }
  .container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
  }
  .device-box {
    background: #fff;
    width: 250px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    text-align: center;
  }
  .device-name {
    font-size: 20px;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 10px;
  }
  .pm-values {
    font-size: 14px;
    color: #333;
    margin-bottom: 10px;
  }
  .pm-values span {
    display: block;
    margin: 2px 0;
  }
  .interval-input {
    display: flex;
    gap: 5px;
    margin-top: 5px;
    margin-bottom: 10px;
  }
  .interval-input input {
    width: 50px;
    padding: 3px;
    text-align: center;
  }
  .interval-input button {
    padding: 3px 6px;
    cursor: pointer;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 4px;
  }
  canvas {
    margin-top: 10px;
  }
  #status {
    text-align: center;
    margin-top: 15px;
    color: #666;
  }
</style>
</head>
<body>

<h1>Air Quality Dashboard</h1>
<p id="status">Connecting to Firebase...</p>
<div class="container" id="deviceContainer"></div>

<script>
  // 🔹 Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBp6Ac1Q2RhCUDuRIhvQ5MkAd-XYQHGcOk",
    authDomain: "pm-monitor-1949c.firebaseapp.com",
    databaseURL: "https://pm-monitor-1949c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "pm-monitor-1949c",
    storageBucket: "pm-monitor-1949c.firebasestorage.app",
    messagingSenderId: "252989379253",
    appId: "1:252989379253:web:1b000622362d26fa9fe4fc",
    measurementId: "G-ZSMT3DQ9TY"
  };

  // 🔹 Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const container = document.getElementById("deviceContainer");
  const statusText = document.getElementById("status");
  const charts = {};

  // 🔹 Predefined Login Credentials
  const predefinedEmail = "mr.d2003feb@gmail.com";
  const predefinedPassword = "mahin123";

  // 🔹 Auto Login
  auth.onAuthStateChanged(user => {
    if (user) {
      statusText.textContent = "Connected ✔";
      loadDashboard();
    } else {
      statusText.textContent = "Signing in...";
      auth.signInWithEmailAndPassword(predefinedEmail, predefinedPassword)
        .catch(err => {
          statusText.textContent = "❌ Login failed: " + err.message;
        });
    }
  });

  // 🔹 Load Dashboard
  function loadDashboard() {
    db.ref("devices").on("value", snapshot => {
      const data = snapshot.val();
      container.innerHTML = "";

      for (let deviceID in data) {
        const d = data[deviceID];
        const box = document.createElement("div");
        box.className = "device-box";
        box.innerHTML = `
          <div class="device-name">${d.name || deviceID}</div>
          <div class="pm-values">
            <span>PM1.0: ${d.PM1 || "-"}</span>
            <span>PM2.5: ${d.PM25 || "-"}</span>
            <span>PM10: ${d.PM10 || "-"}</span>
            <span>Last Update: ${d.Time || "-"}</span>
          </div>
          <div class="interval-input">
            <input type="number" min="1" value="${d.interval || 10}" id="input-${deviceID}">
            <button onclick="updateInterval('${deviceID}')">Set</button>
          </div>
          <div>Current Interval: ${d.interval || "-"}s</div>
          <canvas id="chart-${deviceID}" width="220" height="100"></canvas>
        `;
        container.appendChild(box);

        // Chart handling
        if (!charts[deviceID]) {
          const ctx = document.getElementById(`chart-${deviceID}`).getContext('2d');
          charts[deviceID] = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [{
                label: 'PM2.5',
                data: [],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0,123,255,0.2)',
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true } }
            }
          });
        }

        const chart = charts[deviceID];
        const now = d.Time || new Date().toLocaleTimeString();
        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(d.PM25 || 0);
        if (chart.data.labels.length > 20) {
          chart.data.labels.shift();
          chart.data.datasets[0].data.shift();
        }
        chart.update();
      }
    });
  }

  // 🔹 Update Interval Function
  function updateInterval(deviceID) {
    const input = document.getElementById(`input-${deviceID}`);
    let val = parseInt(input.value);
    if (val >= 1) {
      db.ref(`devices/${deviceID}/interval`).set(val)
        .then(() => alert(`${deviceID} interval updated to ${val}s`))
        .catch(err => alert("Error: " + err));
    } else {
      alert("Interval must be at least 1 second");
    }
  }
</script>

</body>
</html>
